<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1a22" />
  <title>Painel de Horário • Premium</title>

  <!-- Fonte (sem serifa moderna) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&display=swap"
    rel="stylesheet"
  >

  <!-- Material Icons -->
  <link
    href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
    rel="stylesheet"
  />

  <style>
    :root{
      --glass-bg: rgba(255,255,255,.10);
      --glass-bg-2: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.94);
      --text-dim: rgba(255,255,255,.72);
      --text-faint: rgba(255,255,255,.55);

      --shadow: 0 28px 80px rgba(0, 0, 0, .22);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.14);

      --radius: 28px;
      --padX: clamp(18px, 3.2vw, 44px);
      --padY: clamp(18px, 3.0vw, 36px);

      --clock-size: min(15vw, 180px); /* regra pedida: 15vw (cap para telas enormes) */
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      overflow:hidden;
      display:grid;
      place-items:center;
      background:#07141b; /* fallback */
    }

    /* Fundo dinâmico por horário do dia (transição suave) */
    .bg{
      position:fixed;
      inset:-20vmax;
      z-index:-5;
      pointer-events:none;
      filter:saturate(110%);
    }
    .bg-layer{
      position:absolute;
      inset:0;
      opacity:0;
      transition: opacity 1200ms ease-in-out, transform 1200ms ease-in-out;
      transform: scale(1.02);
    }
    .bg-layer.active{
      opacity:1;
      transform: scale(1.00);
    }

    /* Temas: manhã, tarde, noite (azul marinho / petróleo) */
    .bg-morning{
      background:
        radial-gradient(1200px 900px at 30% 20%,
          rgba(120, 220, 255, .42) 0%,
          rgba(40, 160, 210, .24) 35%,
          rgba(10, 46, 62, .00) 70%),
        radial-gradient(900px 700px at 70% 70%,
          rgba(110, 245, 210, .22) 0%,
          rgba(15, 80, 95, .14) 45%,
          rgba(6, 18, 24, .00) 75%),
        radial-gradient(1400px 1100px at 50% 50%,
          #0a2d3c 0%,
          #071b23 55%,
          #061117 100%);
    }
    .bg-afternoon{
      background:
        radial-gradient(1200px 900px at 35% 25%,
          rgba(90, 170, 255, .34) 0%,
          rgba(35, 115, 165, .22) 35%,
          rgba(8, 30, 42, .00) 70%),
        radial-gradient(900px 700px at 75% 70%,
          rgba(85, 230, 205, .18) 0%,
          rgba(20, 120, 120, .12) 45%,
          rgba(6, 18, 24, .00) 75%),
        radial-gradient(1400px 1100px at 50% 55%,
          #072636 0%,
          #061a23 58%,
          #050f15 100%);
    }
    .bg-night{
      background:
        radial-gradient(1200px 900px at 30% 20%,
          rgba(120, 150, 255, .18) 0%,
          rgba(30, 80, 120, .14) 38%,
          rgba(6, 18, 24, .00) 72%),
        radial-gradient(900px 700px at 80% 75%,
          rgba(70, 220, 200, .12) 0%,
          rgba(18, 85, 92, .10) 46%,
          rgba(6, 18, 24, .00) 75%),
        radial-gradient(1400px 1100px at 50% 55%,
          #071b2a 0%,
          #050f15 62%,
          #040a0f 100%);
    }

    /* Névoa/ruído sutil */
    .noise{
      position:fixed;
      inset:0;
      z-index:-4;
      pointer-events:none;
      opacity:.10;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.4'/%3E%3C/svg%3E");
      background-size: 180px 180px;
      mix-blend-mode: overlay;
    }

    .wrap{
      width:min(1100px, 92vw);
      display:grid;
      place-items:center;
      gap: 18px;
      padding: 18px;
    }

    .badge{
      position:relative;
      width:min(980px, 92vw);
      padding: var(--padY) var(--padX);
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--glass-bg), var(--glass-bg-2));
      box-shadow: var(--shadow), var(--shadow-soft);
      border: 1px solid rgba(255,255,255,.22);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      overflow:hidden;
    }

    /* Borda “cristal” */
    .badge::before{
      content:"";
      position:absolute;
      inset:0;
      border-radius: inherit;
      padding: 1px;
      background:
        linear-gradient(140deg,
          rgba(255,255,255,.55),
          rgba(255,255,255,.18),
          rgba(255,255,255,.40));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
              mask-composite: exclude;
      pointer-events:none;
      opacity:.85;
    }

    /* Reflexo sutil */
    .badge::after{
      content:"";
      position:absolute;
      inset:-30% -25% auto -25%;
      height:70%;
      transform: rotate(10deg);
      background:
        radial-gradient(closest-side,
          rgba(255,255,255,.35),
          rgba(255,255,255,.14),
          rgba(255,255,255,0));
      pointer-events:none;
      opacity:.55;
    }

    .inner{
      position:relative;
      z-index:1;
      display:grid;
      gap: clamp(10px, 1.6vw, 18px);
      text-align:center;
    }

    .date{
      font-size: clamp(14px, 1.55vw, 20px);
      letter-spacing: .26em;
      text-transform: uppercase;
      color: var(--text-dim);
      font-weight: 300;
      line-height: 1.2;
      text-shadow: 0 2px 10px rgba(0,0,0,.12);
      user-select:none;
    }

    .clock{
      display:flex;
      align-items: baseline;
      justify-content:center;
      gap: clamp(10px, 1.2vw, 18px);
      user-select:none;
      white-space:nowrap;
    }

    .hm{
      font-size: var(--clock-size);
      font-weight: 200; /* extra-fino */
      letter-spacing: .02em;
      line-height: .95;
      text-shadow: 0 18px 60px rgba(0,0,0,.18);
    }

    .sec{
      font-size: clamp(18px, 3.2vw, 46px);
      font-weight: 300;
      color: var(--text-faint);
      letter-spacing: .10em;
      line-height: 1;
      transform: translateY(-.18em);
      min-width: 2ch;
      text-align:left;
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.22),
        rgba(255,255,255,0));
      margin: 2px auto 0;
      width: min(520px, 90%);
      opacity:.9;
    }

    footer{
      width:min(980px, 92vw);
      display:flex;
      justify-content:flex-end; /* sem “modo quiosque ativo” */
      align-items:center;
      padding: 0 8px;
      color: var(--text-faint);
      font-size: clamp(12px, 1.2vw, 14px);
      letter-spacing: .12em;
      text-transform: uppercase;
      user-select:none;
      gap: 12px;
    }

    .loc{
      display:flex;
      align-items:center;
      gap: 10px;
      white-space:nowrap;
    }

    .material-icons-outlined{
      font-size: 18px;
      opacity:.9;
      transform: translateY(-1px);
    }

    /* Modo offline elegante */
    .offline{
      opacity:.7;
    }

    /* Melhor leitura em TVs grandes */
    @media (min-width: 1400px){
      :root{ --clock-size: 15vw; }
    }

    @media (pointer:coarse){
      body{ touch-action:none; }
    }
  </style>
</head>

<body>
  <!-- Fundo -->
  <div class="bg" aria-hidden="true">
    <div class="bg-layer bg-morning" data-theme="morning"></div>
    <div class="bg-layer bg-afternoon" data-theme="afternoon"></div>
    <div class="bg-layer bg-night" data-theme="night"></div>
  </div>
  <div class="noise" aria-hidden="true"></div>

  <!-- Conteúdo -->
  <main class="wrap">
    <section class="badge" role="group" aria-label="Painel de horário digital">
      <div class="inner">
        <div id="date" class="date">—</div>

        <div class="clock" aria-label="Relógio em tempo real">
          <div id="hm" class="hm">--:--</div>
          <div id="sec" class="sec">--</div>
        </div>

        <div class="divider" aria-hidden="true"></div>
      </div>
    </section>

    <footer aria-label="Informações de rodapé">
      <div class="loc" title="Local detectado via IP (sem permissões)">
        <span class="material-icons-outlined" aria-hidden="true">location_on</span>
        <span id="locationText">LOCALIZANDO…</span>
      </div>
    </footer>
  </main>

  <script>
    // ======= Relógio + Data (tempo real) =======
    const hmEl  = document.getElementById('hm');
    const secEl = document.getElementById('sec');
    const dateEl = document.getElementById('date');
    const locationEl = document.getElementById('locationText');

    const weekday = ["DOMINGO","SEGUNDA-FEIRA","TERÇA-FEIRA","QUARTA-FEIRA","QUINTA-FEIRA","SEXTA-FEIRA","SÁBADO"];
    const month   = ["JANEIRO","FEVEREIRO","MARÇO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];

    function pad2(n){ return String(n).padStart(2,'0'); }

    function formatFullDate(d){
      const w = weekday[d.getDay()];
      const day = pad2(d.getDate());
      const m = month[d.getMonth()];
      const y = d.getFullYear();
      return `${w} • ${day} DE ${m} DE ${y}`;
    }

    function updateClock(){
      const now = new Date();
      const h = pad2(now.getHours());
      const m = pad2(now.getMinutes());
      const s = pad2(now.getSeconds());
      hmEl.textContent = `${h}:${m}`;
      secEl.textContent = s;
      dateEl.textContent = formatFullDate(now);
    }

    function startClock(){
      updateClock();
      const now = new Date();
      const msToNextSecond = 1000 - now.getMilliseconds();
      setTimeout(() => {
        updateClock();
        setInterval(updateClock, 1000);
      }, msToNextSecond);
    }

    // ======= Fundo dinâmico por horário do dia =======
    const layers = Array.from(document.querySelectorAll('.bg-layer'));

    function getThemeByHour(hour){
      if (hour >= 5 && hour < 12) return 'morning';
      if (hour >= 12 && hour < 18) return 'afternoon';
      return 'night';
    }

    let currentTheme = null;

    function applyTheme(theme){
      if (theme === currentTheme) return;
      currentTheme = theme;
      for (const layer of layers){
        layer.classList.toggle('active', layer.dataset.theme === theme);
      }
    }

    function updateTheme(){
      const now = new Date();
      applyTheme(getThemeByHour(now.getHours()));
    }

    function startThemeScheduler(){
      updateTheme();
      setInterval(updateTheme, 60 * 1000);
    }

    // ======= Localização via IP (sem permissões) + fallback + timeout + cache =======
    const LOCATION_CACHE_KEY = 'pv_location_cache_v1';
    const LOCATION_CACHE_TTL_MS = 12 * 60 * 60 * 1000; // 12h
    const REQUEST_TIMEOUT_MS = 2500;

    function withTimeout(promiseFactory, ms = REQUEST_TIMEOUT_MS){
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      return promiseFactory(ctrl.signal).finally(() => clearTimeout(t));
    }

    async function fetchJson(url, signal){
      const res = await fetch(url, {
        signal,
        cache: 'no-store',
        headers: { 'Accept': 'application/json' }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function normalizeUF(region){
      // Se já vier "SP", "PR" etc, mantém.
      const r = (region || '').trim();
      if (!r) return '';

      const map = {
        "ACRE":"AC","ALAGOAS":"AL","AMAPÁ":"AP","AMAPA":"AP","AMAZONAS":"AM","BAHIA":"BA","CEARÁ":"CE","CEARA":"CE",
        "DISTRITO FEDERAL":"DF","ESPÍRITO SANTO":"ES","ESPIRITO SANTO":"ES","GOIÁS":"GO","GOIAS":"GO","MARANHÃO":"MA","MARANHAO":"MA",
        "MATO GROSSO":"MT","MATO GROSSO DO SUL":"MS","MINAS GERAIS":"MG","PARÁ":"PA","PARA":"PA","PARAÍBA":"PB","PARAIBA":"PB",
        "PARANÁ":"PR","PARANA":"PR","PERNAMBUCO":"PE","PIAUÍ":"PI","PIAUI":"PI","RIO DE JANEIRO":"RJ","RIO GRANDE DO NORTE":"RN",
        "RIO GRANDE DO SUL":"RS","RONDÔNIA":"RO","RONDONIA":"RO","RORAIMA":"RR","SANTA CATARINA":"SC","SÃO PAULO":"SP","SAO PAULO":"SP",
        "SERGIPE":"SE","TOCANTINS":"TO"
      };

      // Se vier com 2 letras, assume UF
      if (r.length === 2) return r.toUpperCase();
      const upper = r.toUpperCase();
      return map[upper] || r;
    }

    function formatPlace({ city, region, country }){
      city = (city || '').trim();
      region = normalizeUF(region);
      country = (country || '').trim();

      // Preferência BR: Cidade • UF
      if (city && region) return `${city} • ${region}`;
      if (city && country) return `${city} • ${country}`;
      if (region && country) return `${region} • ${country}`;
      return country || 'LOCAL INDISPONÍVEL';
    }

    function setOfflineLabel(){
      locationEl.textContent = 'OFFLINE';
      locationEl.classList.add('offline');
    }

    function setLocationLabel(label){
      locationEl.classList.remove('offline');
      locationEl.textContent = label;
    }

    function loadCachedLocation(){
      try{
        const raw = localStorage.getItem(LOCATION_CACHE_KEY);
        if (!raw) return null;
        const cached = JSON.parse(raw);
        if (!cached || !cached.label || !cached.ts) return null;
        if (Date.now() - cached.ts > LOCATION_CACHE_TTL_MS) return null;
        return cached.label;
      }catch{
        return null;
      }
    }

    function saveCachedLocation(label){
      try{
        localStorage.setItem(LOCATION_CACHE_KEY, JSON.stringify({ label, ts: Date.now() }));
      }catch{}
    }

    async function detectLocationViaIP(){
      // 1) Se estiver offline, mostra OFFLINE imediatamente (e não fica tentando)
      if (!navigator.onLine){
        setOfflineLabel();
        return;
      }

      // 2) Cache local (12h)
      const cached = loadCachedLocation();
      if (cached){
        setLocationLabel(cached);
        // atualiza em background (não bloqueia)
        // (sem promessas penduradas: apenas dispara)
        void refreshLocation();
        return;
      }

      // 3) Primeiro carregamento
      locationEl.textContent = 'LOCALIZANDO…';
      await refreshLocation();
    }

    async function refreshLocation(){
      const providers = [
        async (signal) => {
          // ipapi.co
          const d = await fetchJson('https://ipapi.co/json/', signal);
          return { city: d.city, region: d.region, country: d.country_name };
        },
        async (signal) => {
          // ipwho.is
          const d = await fetchJson('https://ipwho.is/', signal);
          if (!d || d.success === false) throw new Error('ipwho.is failed');
          return { city: d.city, region: d.region, country: d.country };
        },
        async (signal) => {
          // ipinfo.io (pode rate-limit dependendo do volume)
          const d = await fetchJson('https://ipinfo.io/json', signal);
          return { city: d.city, region: d.region, country: d.country };
        }
      ];

      for (const provider of providers){
        try{
          const place = await withTimeout(provider, REQUEST_TIMEOUT_MS);
          const label = formatPlace(place);

          if (label && label !== 'LOCAL INDISPONÍVEL'){
            setLocationLabel(label);
            saveCachedLocation(label);
            return;
          }
        }catch{
          // tenta próximo
        }
      }

      // Se falhar mas estiver online: mantém “LOCAL INDISPONÍVEL”
      setLocationLabel('LOCAL INDISPONÍVEL');
    }

    // Atualiza etiqueta quando cair / voltar internet
    window.addEventListener('offline', setOfflineLabel);
    window.addEventListener('online', () => { void detectLocationViaIP(); });

    // ======= Boot =======
    startClock();
    startThemeScheduler();
    detectLocationViaIP();
  </script>
</body>
</html>
